name: Deploy to Digital Ocean Droplet

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag to deploy (default: latest commit SHA)'
        required: false
        default: ''

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository }}

jobs:
  # ===========================================================================
  # Test Job - Run linting and tests
  # ===========================================================================
  test:
    name: Test
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_PASSWORD: test
          POSTGRES_USER: test
          POSTGRES_DB: test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: dashboard/package-lock.json

      # Go linting
      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest
        continue-on-error: true

      # Go tests - run in each service directory (go.work workspace)
      - name: Run Go tests
        run: |
          for dir in services/ims-api services/ssot-school services/ssot-devices services/ssot-parts services/ssot-hr services/sync-worker shared; do
            echo "Testing $dir..."
            cd $dir
            go test -v -race -short ./... || true
            cd -
          done
        env:
          DATABASE_URL: postgres://test:test@localhost:5432/test?sslmode=disable

      # Dashboard build
      - name: Install dashboard dependencies
        working-directory: dashboard
        run: npm ci

      - name: Lint dashboard
        working-directory: dashboard
        run: npm run lint

      - name: Build dashboard
        working-directory: dashboard
        run: npm run build

      - name: Run dashboard tests
        working-directory: dashboard
        run: npm run test

  # ===========================================================================
  # Build Job - Build and push Docker images
  # ===========================================================================
  build:
    name: Build & Push Images
    runs-on: ubuntu-latest
    needs: test
    permissions:
      contents: read
      packages: write

    strategy:
      matrix:
        service:
          - ims-api
          - ssot-school
          - ssot-devices
          - ssot-parts
          - ssot-hr
          - sync-worker

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.service }}
          tags: |
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: services/${{ matrix.service }}/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ===========================================================================
  # Deploy Job - Deploy to Digital Ocean Droplet
  # ===========================================================================
  deploy:
    name: Deploy to Droplet
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine image tag
        id: tag
        run: |
          if [ -n "${{ github.event.inputs.image_tag }}" ]; then
            echo "tag=${{ github.event.inputs.image_tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${{ github.sha }}" >> $GITHUB_OUTPUT
          fi

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DROPLET_SSH_KEY }}" | base64 -d > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.DROPLET_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

      - name: Test SSH connection
        run: |
          ssh -o StrictHostKeyChecking=no -o BatchMode=yes -o ConnectTimeout=10 \
            ${{ secrets.DROPLET_USER }}@${{ secrets.DROPLET_HOST }} "echo 'SSH OK'"

      - name: Copy deployment files
        run: |
          scp -o StrictHostKeyChecking=no -o BatchMode=yes \
            deployments/docker/docker-compose.prod.yml \
            deployments/docker/nginx.prod.conf \
            deployments/docker/init-databases.sql \
            scripts/deploy-droplet.sh \
            ${{ secrets.DROPLET_USER }}@${{ secrets.DROPLET_HOST }}:/tmp/

      - name: Deploy to droplet
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.DROPLET_USER }}@${{ secrets.DROPLET_HOST }} << ENDSSH
            set -e

            # Create deployment directory
            mkdir -p /opt/essp
            cd /opt/essp

            # Move deployment files
            mv /tmp/docker-compose.prod.yml . 2>/dev/null || true
            mv /tmp/nginx.prod.conf . 2>/dev/null || true
            mv /tmp/init-databases.sql . 2>/dev/null || true
            mv /tmp/deploy-droplet.sh . 2>/dev/null || true
            chmod +x deploy-droplet.sh

            # Install Docker first (if not present)
            ./deploy-droplet.sh install

            # Create .env file if it doesn't exist
            if [ ! -f .env ]; then
              cat > .env << 'ENVEOF'
          GITHUB_REPOSITORY=${{ github.repository }}
          IMAGE_TAG=${{ steps.tag.outputs.tag }}
          POSTGRES_USER=essp
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
          MINIO_ACCESS_KEY=minioadmin
          MINIO_SECRET_KEY=${{ secrets.MINIO_SECRET_KEY }}
          AUTH_ENABLED=false
          APP_ENV=production
          LOG_LEVEL=info
          ENVEOF
            else
              # Update IMAGE_TAG in existing .env
              sed -i "s/^IMAGE_TAG=.*/IMAGE_TAG=${{ steps.tag.outputs.tag }}/" .env
            fi

            # Login to GHCR (Docker is now installed)
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u github --password-stdin

            # Run deployment
            export IMAGE_TAG="${{ steps.tag.outputs.tag }}"
            export GITHUB_REPOSITORY="${{ github.repository }}"
            ./deploy-droplet.sh deploy
          ENDSSH

      - name: Verify deployment
        run: |
          sleep 30
          ssh -o StrictHostKeyChecking=no ${{ secrets.DROPLET_USER }}@${{ secrets.DROPLET_HOST }} << 'ENDSSH'
            cd /opt/essp
            docker compose -f docker-compose.prod.yml ps
            curl -sf http://localhost/healthz || echo "Health check endpoint not ready yet"
          ENDSSH

      - name: Deployment summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Host:** ${{ secrets.DROPLET_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Tag:** ${{ steps.tag.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
